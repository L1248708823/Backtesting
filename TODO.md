# 量化回测系统 - 任务清单（基于PRD需求）

> **最后更新**: 2025-09-11  
> **项目状态**: DCA策略核心完成阶段 - 双重回测系统实施完毕  
> **下一里程碑**: 数据源优化 + 图表可视化，打造专业回测体验

## 📋 **项目需求回顾（来自PRD.md）**

### 🎯 **核心目标**
- **产品定位**: 个人专用的量化交易策略回测验证平台，**专注ETF轮动等策略**的可行性验证
- **主要用户**: 具备Python编程能力的投资者，开发ETF轮动策略后进行历史数据验证
- **用户流程**: 策略选择页 → 参数配置页 → 回测执行页 → 结果展示页

### 📊 **PRD明确的功能需求**
- ✅ **多策略支持**: 定投、轮动、均值回归等多种预设策略
- ✅ **策略选择页**: 展示可用策略列表，策略简介，策略选择操作
- ✅ **动态参数配置**: 根据选择的策略动态生成参数表单
- ✅ **ETF轮动策略**: 支持月度/季度/年度轮动周期，可配置轮动的ETF池范围
- ✅ **详细回测报告**: 收益曲线、最大回撤、夏普比率、胜率等关键指标

### 🏗️ **技术架构需求**
- **后端**: Python + FastAPI + **Backtrader** + SQLite
- **前端**: React + TypeScript + Ant Design + ECharts  
- **数据源**: AKShare(A股) + yfinance(美股)

## 🎉 **重大突破完成 - DCA策略双重回测系统 (2025-09-11 最新状态)**

### 🏆 **核心功能已完成 (2025-09-11 更新)**
- **✅ DCA策略后端**: **双重回测系统完成** - 解决基准对比计算错误
- **✅ DCA策略前端**: **忍者风格完整体验** - 终端配置 + 详细结果展示  
- **✅ 基准对比系统**: **真实回测数据对比** - 消除理论计算误差
- **✅ 性能指标完备**: **专业级回测报告** - 夏普比率、最大回撤、JSDoc详细说明
- **✅ 用户体验优化**: **金额快速选择 + 定投月数显示** - 配置便捷，对比清晰

### 🚀 **技术突破成果**
1. **双重回测方案**: 非hold策略自动执行两次回测（用户策略 vs 纯持有），基准对比数据来自真实回测结果
2. **数据一致性保证**: 两个策略使用相同定投记录基础，消除2.79% vs 836.11%等荒谬对比
3. **代码架构优化**: 删除错误理论计算，实施"简单粗暴"的双回测方案
4. **前端体验完善**: 初始资金默认10万、快速选择按钮、左右对比框显示定投月数

## 🔥 **已完成任务标记 - DCA策略核心功能 (2025-09-11 状态更新)**

### 📊 **第一阶段：后端数据增强** ✅ **已完成**
- [x] **分析当前Backtrader数据结构** ✅ **完成**
  - [x] 检查当前DCA策略返回的数据格式
  - [x] 了解Backtrader可提供的详细数据类型
  - [x] 确认数据获取方式和处理流程

- [x] **增强DCA策略后端数据输出** ✅ **完成**
  - [x] 添加详细定投记录（每次买入时间、金额、价格、份额）
  - [x] 计算关键投资指标（年化收益率、最大回撤、夏普比率、胜率）
  - [x] 生成收益曲线时间序列数据（日收益、累计收益）
  - [x] **实施双重回测系统** - 基于真实回测的基准对比数据
  - [x] **删除错误理论计算** - 简化架构，提高准确性

### 🖥️ **第二阶段：前端结果页面重构** ✅ **基本完成**
- [x] **分析当前DCA前端结果页面** ✅ **完成**
  - [x] 检查现有结果展示内容
  - [x] 确认缺失的展示组件
  - [x] 了解当前数据接收和处理方式

- [x] **重构DCA结果展示页面** ✅ **完成**
  - [x] 实现定投明细表格组件（每次买入详情）
  - [x] 添加关键指标仪表盘（年化收益、最大回撤等）
  - [x] 添加基准对比分析区域（双重回测结果对比）
  - [x] **完善左右对比框显示定投月数**
  - [x] 保持忍者终端UI风格一致性

### 🎛️ **用户体验优化** ✅ **完成**
- [x] **DCATerminalConfig金额快速选择功能**
  - [x] 初始资金默认值改为10万
  - [x] 投资金额快速选择（500/1000/2000/3000/5000）
  - [x] 初始资金快速选择（5万/10万/20万/50万）
  - [x] 忍者终端风格按钮样式

- [x] **UI样式修复**
  - [x] 修复分页UI样式问题（页码按钮颜色和字体）
  - [x] 添加卖出信息到执行日志

## 🔥 **当前任务重点 - 完善用户体验 (2025-09-11 新增任务)**

### 🔧 **P1 高优先级任务**

#### 📈 **数据源稳定性优化** `P1 立即处理`
- [ ] **修复纳斯达克数据获取问题** 
  - [ ] 调试QQQ等美股ETF数据获取失败问题
  - [ ] 验证yfinance参数配置和调用方式
  - [ ] 测试多个美股ETF数据源连接稳定性
  - [ ] 添加数据获取异常处理和用户友好提示

#### 📊 **可视化分析增强** `P1 重要提升`
- [x] **集成ECharts图表组件系统**
  - [x] 实现收益曲线图（策略 vs 基准对比曲线）
  - [ ] 添加净值走势图（时间序列可视化）
  - [x] 实现最大回撤分析图（回撤深度和持续时间）
  - [ ] 优化忍者终端风格图表配色和交互

#### 🧪 **系统稳定性验证** `P1 质量保证`
- [ ] **完整DCA流程压力测试**
  - [ ] 验证双重回测系统准确性和性能
  - [ ] 测试各种止盈策略场景的计算正确性
  - [ ] 压力测试不同时间范围和参数组合
  - [ ] 确认基准对比数据的一致性和可靠性

### 📈 **P2 中优先级任务**

#### 🔄 **策略扩展准备** `P2 功能扩展`
- [ ] **ETF轮动策略开发前准备**
  - [ ] 基于DCA经验总结策略开发模板
  - [ ] 设计轮动策略的参数配置界面
  - [ ] 规划轮动策略的回测逻辑框架

#### 💾 **数据持久化基础** `P2 系统完善`
- [ ] **历史回测记录保存**
  - [ ] SQLite数据模型设计
  - [ ] 回测结果的存储和查询功能
  - [ ] 历史策略对比分析功能

## 📝 **降级处理的任务** (延后到DCA完善后)

### 📊 **ETF轮动策略开发** (推迟 - P1级别)
- [ ] 实现ETF轮动策略后端逻辑
- [ ] 创建ETF轮动前端页面
- [ ] ETF轮动策略完整联调

### 🗄️ **数据库持久化功能** (推迟 - P2级别)  
- [ ] SQLite集成和数据模型设计
- [ ] 历史回测记录保存
- [ ] 策略结果对比功能

### 🎨 **UI风格优化** (推迟 - P3级别)
- [ ] 策略选择页面UI改进
- [ ] 通用组件抽象和重构
- [ ] 系统性能和用户体验优化

## 🔮 **P2级别功能扩展清单** (基于回测平台完整性分析)

> **说明**: 以下功能基于市场分析，旨在打造最全面的定投策略实验室
> **优先级**: P2 - 在当前DCA基础功能完成后考虑开发

### 🔄 **止盈后再入场机制** (P2 - 核心扩展功能)
- [ ] **再入场触发条件配置**
  - [ ] 价格回调触发：相对止盈价格下跌X%后再次开始定投
  - [ ] 时间触发：止盈后等待固定天数再开始定投
  - [ ] 估值触发：基于PE/PB等估值指标的再入场判断
  - [ ] 手动触发：用户手动决定再入场时机

- [ ] **再入场策略参数**
  - [ ] `re_enter_after_exit`: 是否启用再入场 (boolean)
  - [ ] `re_enter_condition`: 再入场条件类型 (price_drop/time_based/valuation/manual)
  - [ ] `re_enter_threshold`: 价格回调百分比 (float, 默认10.0%)
  - [ ] `re_enter_wait_days`: 最短等待天数 (int, 默认30天)
  - [ ] `max_re_enter_times`: 最大再入场次数 (int, 默认3次)
  - [ ] `re_enter_amount_ratio`: 再入场时的投资金额比例 (float, 默认1.0)

### 📊 **估值驱动智能定投** (P2 - 市场对标功能)
- [ ] **估值指标集成**
  - [ ] PE/PB历史分位数计算
  - [ ] 市场情绪指标（恐贪指数等）
  - [ ] 宏观经济指标接入（可选）

- [ ] **智能调整机制**
  - [ ] `use_valuation_timing`: 启用估值择时 (boolean)
  - [ ] `pe_percentile_low`: PE历史分位数低点 (float, 默认20%)
  - [ ] `pe_percentile_high`: PE历史分位数高点 (float, 默认80%)
  - [ ] `investment_multiplier_low`: 低估时投资倍数 (float, 默认2.0)
  - [ ] `investment_multiplier_high`: 高估时投资倍数 (float, 默认0.5)

### ⚠️ **风险控制体系完善** (P2 - 专业平台必备)
- [ ] **止损机制**
  - [ ] `enable_stop_loss`: 启用止损 (boolean)
  - [ ] `stop_loss_percentage`: 止损百分比 (float, 默认-20.0%)
  - [ ] `stop_loss_type`: 止损类型 (trailing/fixed/time_based)

- [ ] **仓位风险管理**
  - [ ] `max_single_investment_ratio`: 单次投资占总资金比例上限 (float, 默认0.1)
  - [ ] `max_position_ratio`: 最大持仓比例 (float, 默认0.8)
  - [ ] `cash_reserve_ratio`: 现金储备比例 (float, 默认0.1)

### 📈 **市场环境自适应** (P2 - 高级策略)
- [ ] **趋势识别系统**
  - [ ] `market_trend_detection`: 启用趋势检测 (boolean)
  - [ ] 牛熊市判断逻辑（基于均线、波动率等）
  - [ ] `bull_market_multiplier`: 牛市投资倍数调整 (float, 默认0.8)
  - [ ] `bear_market_multiplier`: 熊市投资倍数调整 (float, 默认1.5)

- [ ] **波动率自适应**
  - [ ] `volatility_adjustment`: 启用波动率调整 (boolean)
  - [ ] 高波动期减少投资，低波动期增加投资
  - [ ] `volatility_threshold`: 波动率阈值设定

### 🏗️ **高级定投策略模式** (P2 - 策略丰富度)
- [ ] **金字塔定投（Pyramid DCA）**
  - [ ] `pyramid_investing`: 启用金字塔定投 (boolean)
  - [ ] 跌幅越大投资越多的渐进式策略
  - [ ] `pyramid_levels`: 金字塔层级设置 (array)

- [ ] **微笑曲线策略（Smile Curve）**
  - [ ] `smile_curve_strategy`: 启用微笑曲线 (boolean)
  - [ ] 两端（高点/低点）减少投资，中间区间正常投资

- [ ] **动量因子集成**
  - [ ] `momentum_factor`: 动量因子强度 (float, -1到1)
  - [ ] 正值跟随趋势，负值逆向投资

### 📋 **策略组合与对比** (P2 - 回测平台核心价值)
- [ ] **多策略并行回测**
  - [ ] 同一时间段不同参数的策略对比
  - [ ] 策略表现排行榜
  - [ ] 最优参数自动寻找

- [ ] **基准策略扩展**
  - [ ] 纯买入持有策略
  - [ ] 等权重再平衡策略
  - [ ] 市值加权策略对比

### 🎯 **用户体验增强** (P2 - 易用性提升)
- [ ] **策略模板系统**
  - [ ] 预设经典定投模板（保守/均衡/激进）
  - [ ] 用户自定义模板保存
  - [ ] 社区策略分享（可选）

- [ ] **参数敏感性分析**
  - [ ] 关键参数对结果的影响分析
  - [ ] 参数优化建议
  - [ ] Monte Carlo不确定性分析

### 📊 **数据源扩展** (P2 - 数据完整性)
- [ ] **更多数据接入**
  - [ ] 更多ETF品种支持
  - [ ] 港股、美股数据补全
  - [ ] 宏观经济数据接入

- [ ] **数据质量保证**
  - [ ] 数据缺失处理策略
  - [ ] 异常数据识别和处理
  - [ ] 数据更新自动化

## 🏆 **双重回测系统实施效果评估**

### 🎯 **核心问题解决**
1. **✅ 基准对比准确性**: 彻底解决2.79% vs 836.11%等荒谬数据对比问题
2. **✅ 数据一致性保证**: 两个策略基于完全相同的定投记录和时间基础
3. **✅ 用户信任度提升**: 基准对比数据来自真实回测，消除理论计算误差
4. **✅ 代码架构简化**: 删除复杂理论计算，采用"简单粗暴"的双回测方案

### 💡 **技术架构创新**
1. **双回测自动化**: 非hold策略自动触发两次回测，用户透明使用
2. **数据源统一**: 主策略和基准策略使用同一数据源和时间序列
3. **性能优化**: 纯hold策略保持单次回测，避免不必要的计算开销
4. **结果可信度**: 基准对比结果具备投资决策参考价值

### 📊 **用户体验优化成果**
1. **配置便捷性**: 初始资金默认10万，投资金额快速选择按钮
2. **对比清晰性**: 左右策略框显示相同定投月数，便于验证数据一致性
3. **专业化程度**: 完整的性能指标（夏普比率、最大回撤）和JSDoc说明
4. **忍者风格统一**: 终端配置页面和结果展示页面风格协调

## 🚀 **快速启动指令** (DCA完善阶段)

### 💻 **服务启动命令**
```bash
# 后端启动 (端口8008)
cd backend && py -3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8008

# 前端启动 (端口3001)  
cd frontend && npm run dev -- --port 3001
```

### 🧪 **测试验证命令**
```bash
# 测试DCA策略API
curl -X POST "http://localhost:8008/api/v1/backtest/run" \
  -H "Content-Type: application/json" \
  -d '{"strategy_id":"dca_strategy","parameters":{"investment_amount":1000,"frequency_days":30,"symbol":"510300"},"start_date":"2023-01-01","end_date":"2023-12-31","initial_cash":10000}'
```

## 🎯 **阶段成功标准**

### ✅ **当前阶段已达成目标 (2025-09-11)**
1. **✅ 数据准确性**: 双重回测系统彻底解决基准对比计算错误
2. **✅ 用户体验**: 忍者风格配置页面 + 详细结果展示完整流程
3. **✅ 技术架构**: 建立了可复用的策略开发和回测框架
4. **✅ 专业程度**: 完备的性能指标和投资决策支持数据

### 🎯 **下一阶段目标**
1. **数据源稳定性**: 解决QQQ等美股ETF数据获取问题
2. **可视化完善**: ECharts图表集成，提供直观的分析体验
3. **系统稳定性**: 全面压力测试，确保双重回测系统可靠性
4. **策略扩展准备**: 基于DCA经验，为ETF轮动等策略做技术储备

### 🏆 **长期愿景**
- 将**双重回测系统**推广到所有策略，确保数据准确性
- 建立**专业级量化回测平台**，支持多种投资策略验证
- 打造**个人投资者专用工具**，提供可信的策略分析能力

---

**重要里程碑**: ✅ DCA策略核心功能已完成！双重回测系统解决了关键的基准对比准确性问题，现在可以安全地进行数据源优化和可视化增强。