# 量化回测系统 - 任务清单（基于PRD需求）

> **最后更新**: 2024-09-11  
> **项目状态**: DCA策略数据完善阶段 - 聚焦回测结果详细展示  
> **下一里程碑**: DCA策略数据完善，提供完整投资参考价值

## 📋 **项目需求回顾（来自PRD.md）**

### 🎯 **核心目标**
- **产品定位**: 个人专用的量化交易策略回测验证平台，**专注ETF轮动等策略**的可行性验证
- **主要用户**: 具备Python编程能力的投资者，开发ETF轮动策略后进行历史数据验证
- **用户流程**: 策略选择页 → 参数配置页 → 回测执行页 → 结果展示页

### 📊 **PRD明确的功能需求**
- ✅ **多策略支持**: 定投、轮动、均值回归等多种预设策略
- ✅ **策略选择页**: 展示可用策略列表，策略简介，策略选择操作
- ✅ **动态参数配置**: 根据选择的策略动态生成参数表单
- ✅ **ETF轮动策略**: 支持月度/季度/年度轮动周期，可配置轮动的ETF池范围
- ✅ **详细回测报告**: 收益曲线、最大回撤、夏普比率、胜率等关键指标

### 🏗️ **技术架构需求**
- **后端**: Python + FastAPI + **Backtrader** + SQLite
- **前端**: React + TypeScript + Ant Design + ECharts  
- **数据源**: AKShare(A股) + yfinance(美股)

## 🔥 **当前聚焦任务 - DCA策略数据完善 (2024-09-11 重新规划)**

### ⚠️ **现状重新评估 (2024-09-11 更新)**
- **DCA策略后端**: ✅ **基础回测逻辑完成** - Backtrader + AKShare集成完成
- **DCA策略前端**: ✅ **忍者风格配置页面完成** - 参数配置功能齐全  
- **DCA策略联调**: ✅ **基础前后端打通完成** - 可执行回测并返回结果
- **关键缺失**: ❌ **回测结果展示严重不足** - 缺乏详细数据，无投资参考价值

### 🎯 **问题核心诊断**
经过深入分析，发现当前最严重的问题：
1. **数据展示不足**: 回测结果只有简单收益率，缺乏投资决策需要的详细信息
2. **用户价值缺失**: 没有定投明细、收益曲线、关键指标，用户无法评估策略效果
3. **投资参考价值为零**: 现有结果页面无法提供任何有价值的投资建议

## 🔥 **P0 立即处理 - DCA策略数据完善**

### 📊 **第一阶段：后端数据增强** (优先级最高)
- [ ] **分析当前Backtrader数据结构** `P0 立即处理`
  - [ ] 检查当前DCA策略返回的数据格式
  - [ ] 了解Backtrader可提供的详细数据类型
  - [ ] 确认数据获取方式和处理流程

- [ ] **增强DCA策略后端数据输出** `P0 立即处理`
  - [ ] 添加详细定投记录（每次买入时间、金额、价格、份额）
  - [ ] 计算关键投资指标（年化收益率、最大回撤、夏普比率、胜率）
  - [ ] 生成收益曲线时间序列数据（日收益、累计收益）
  - [ ] 添加基准对比数据（vs一次性投入、vs指数表现）
  - [ ] 实现投资建议生成（基于回测结果的策略评价）

### 🖥️ **第二阶段：前端结果页面重构** (紧随其后)
- [ ] **分析当前DCA前端结果页面** `P0 立即处理`
  - [ ] 检查现有结果展示内容
  - [ ] 确认缺失的展示组件
  - [ ] 了解当前数据接收和处理方式

- [ ] **重构DCA结果展示页面** `P0 立即处理`
  - [ ] 实现定投明细表格组件（每次买入详情）
  - [ ] 添加关键指标仪表盘（年化收益、最大回撤等）
  - [ ] 设计投资总结卡片（策略评价和建议）
  - [ ] 保持忍者终端UI风格一致性

- [ ] **集成ECharts图表组件** `P0 立即处理`
  - [ ] 实现收益曲线图（累计收益 vs 基准）
  - [ ] 添加净值走势图（策略表现可视化）
  - [ ] 实现回撤分析图（最大回撤时间和深度）
  - [ ] 优化图表忍者风格配色

### 🧪 **第三阶段：完整流程验证** (最终确认)
- [ ] **测试DCA完整用户流程** `P0 立即处理`
  - [ ] 验证从配置到详细结果的完整流程
  - [ ] 确认所有数据正确传递和展示
  - [ ] 测试各种参数配置的结果准确性
  - [ ] 验证投资建议的合理性

## 📝 **降级处理的任务** (延后到DCA完善后)

### 📊 **ETF轮动策略开发** (推迟 - P1级别)
- [ ] 实现ETF轮动策略后端逻辑
- [ ] 创建ETF轮动前端页面
- [ ] ETF轮动策略完整联调

### 🗄️ **数据库持久化功能** (推迟 - P2级别)  
- [ ] SQLite集成和数据模型设计
- [ ] 历史回测记录保存
- [ ] 策略结果对比功能

### 🎨 **UI风格优化** (推迟 - P3级别)
- [ ] 策略选择页面UI改进
- [ ] 通用组件抽象和重构
- [ ] 系统性能和用户体验优化

## 🔮 **P2级别功能扩展清单** (基于回测平台完整性分析)

> **说明**: 以下功能基于市场分析，旨在打造最全面的定投策略实验室
> **优先级**: P2 - 在当前DCA基础功能完成后考虑开发

### 🔄 **止盈后再入场机制** (P2 - 核心扩展功能)
- [ ] **再入场触发条件配置**
  - [ ] 价格回调触发：相对止盈价格下跌X%后再次开始定投
  - [ ] 时间触发：止盈后等待固定天数再开始定投
  - [ ] 估值触发：基于PE/PB等估值指标的再入场判断
  - [ ] 手动触发：用户手动决定再入场时机

- [ ] **再入场策略参数**
  - [ ] `re_enter_after_exit`: 是否启用再入场 (boolean)
  - [ ] `re_enter_condition`: 再入场条件类型 (price_drop/time_based/valuation/manual)
  - [ ] `re_enter_threshold`: 价格回调百分比 (float, 默认10.0%)
  - [ ] `re_enter_wait_days`: 最短等待天数 (int, 默认30天)
  - [ ] `max_re_enter_times`: 最大再入场次数 (int, 默认3次)
  - [ ] `re_enter_amount_ratio`: 再入场时的投资金额比例 (float, 默认1.0)

### 📊 **估值驱动智能定投** (P2 - 市场对标功能)
- [ ] **估值指标集成**
  - [ ] PE/PB历史分位数计算
  - [ ] 市场情绪指标（恐贪指数等）
  - [ ] 宏观经济指标接入（可选）

- [ ] **智能调整机制**
  - [ ] `use_valuation_timing`: 启用估值择时 (boolean)
  - [ ] `pe_percentile_low`: PE历史分位数低点 (float, 默认20%)
  - [ ] `pe_percentile_high`: PE历史分位数高点 (float, 默认80%)
  - [ ] `investment_multiplier_low`: 低估时投资倍数 (float, 默认2.0)
  - [ ] `investment_multiplier_high`: 高估时投资倍数 (float, 默认0.5)

### ⚠️ **风险控制体系完善** (P2 - 专业平台必备)
- [ ] **止损机制**
  - [ ] `enable_stop_loss`: 启用止损 (boolean)
  - [ ] `stop_loss_percentage`: 止损百分比 (float, 默认-20.0%)
  - [ ] `stop_loss_type`: 止损类型 (trailing/fixed/time_based)

- [ ] **仓位风险管理**
  - [ ] `max_single_investment_ratio`: 单次投资占总资金比例上限 (float, 默认0.1)
  - [ ] `max_position_ratio`: 最大持仓比例 (float, 默认0.8)
  - [ ] `cash_reserve_ratio`: 现金储备比例 (float, 默认0.1)

### 📈 **市场环境自适应** (P2 - 高级策略)
- [ ] **趋势识别系统**
  - [ ] `market_trend_detection`: 启用趋势检测 (boolean)
  - [ ] 牛熊市判断逻辑（基于均线、波动率等）
  - [ ] `bull_market_multiplier`: 牛市投资倍数调整 (float, 默认0.8)
  - [ ] `bear_market_multiplier`: 熊市投资倍数调整 (float, 默认1.5)

- [ ] **波动率自适应**
  - [ ] `volatility_adjustment`: 启用波动率调整 (boolean)
  - [ ] 高波动期减少投资，低波动期增加投资
  - [ ] `volatility_threshold`: 波动率阈值设定

### 🏗️ **高级定投策略模式** (P2 - 策略丰富度)
- [ ] **金字塔定投（Pyramid DCA）**
  - [ ] `pyramid_investing`: 启用金字塔定投 (boolean)
  - [ ] 跌幅越大投资越多的渐进式策略
  - [ ] `pyramid_levels`: 金字塔层级设置 (array)

- [ ] **微笑曲线策略（Smile Curve）**
  - [ ] `smile_curve_strategy`: 启用微笑曲线 (boolean)
  - [ ] 两端（高点/低点）减少投资，中间区间正常投资

- [ ] **动量因子集成**
  - [ ] `momentum_factor`: 动量因子强度 (float, -1到1)
  - [ ] 正值跟随趋势，负值逆向投资

### 📋 **策略组合与对比** (P2 - 回测平台核心价值)
- [ ] **多策略并行回测**
  - [ ] 同一时间段不同参数的策略对比
  - [ ] 策略表现排行榜
  - [ ] 最优参数自动寻找

- [ ] **基准策略扩展**
  - [ ] 纯买入持有策略
  - [ ] 等权重再平衡策略
  - [ ] 市值加权策略对比

### 🎯 **用户体验增强** (P2 - 易用性提升)
- [ ] **策略模板系统**
  - [ ] 预设经典定投模板（保守/均衡/激进）
  - [ ] 用户自定义模板保存
  - [ ] 社区策略分享（可选）

- [ ] **参数敏感性分析**
  - [ ] 关键参数对结果的影响分析
  - [ ] 参数优化建议
  - [ ] Monte Carlo不确定性分析

### 📊 **数据源扩展** (P2 - 数据完整性)
- [ ] **更多数据接入**
  - [ ] 更多ETF品种支持
  - [ ] 港股、美股数据补全
  - [ ] 宏观经济数据接入

- [ ] **数据质量保证**
  - [ ] 数据缺失处理策略
  - [ ] 异常数据识别和处理
  - [ ] 数据更新自动化

## 🎯 **DCA数据完善的预期效果**

### 📈 **用户价值提升**
1. **投资决策支持**: 详细的回测数据帮助用户评估DCA策略可行性
2. **风险评估**: 最大回撤、波动率等指标帮助用户了解策略风险
3. **执行指导**: 定投明细为用户提供具体的投资执行方案

### 🏗️ **技术经验积累**
1. **数据展示标准**: 为后续策略建立完整的结果展示模板
2. **ECharts集成**: 建立图表组件库，后续策略可直接复用
3. **指标计算体系**: 建立标准化的策略评价指标计算框架

### 📊 **开发模式验证**
1. **策略独立开发模式**: 验证专注单一策略深度完善的效果
2. **渐进式完善**: 证明从基础功能到完整产品的迭代路径
3. **用户价值导向**: 确认以用户实际需求驱动功能开发的正确性

## 🚀 **快速启动指令** (DCA完善阶段)

### 💻 **服务启动命令**
```bash
# 后端启动 (端口8008)
cd backend && py -3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8008

# 前端启动 (端口3001)  
cd frontend && npm run dev -- --port 3001
```

### 🧪 **测试验证命令**
```bash
# 测试DCA策略API
curl -X POST "http://localhost:8008/api/v1/backtest/run" \
  -H "Content-Type: application/json" \
  -d '{"strategy_id":"dca_strategy","parameters":{"investment_amount":1000,"frequency_days":30,"symbol":"510300"},"start_date":"2023-01-01","end_date":"2023-12-31","initial_cash":10000}'
```

## 🎯 **成功标准**

### ✅ **DCA策略完善完成标志**
1. **数据完整性**: 回测结果包含所有必要的投资分析数据
2. **展示专业性**: 结果页面达到专业投资分析软件的标准
3. **投资实用性**: 用户可基于回测结果做出实际投资决策
4. **技术复用性**: 建立的数据和展示框架可复用到其他策略

### 🏆 **长期目标**
- 将DCA策略打造成策略开发的**黄金标准**
- 为ETF轮动等后续策略提供**完整的开发模板**
- 建立**专业级**的量化回测系统基础

---

**重要提醒**: 聚焦DCA策略数据完善，暂停其他功能开发，确保单一策略的极致体验。