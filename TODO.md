# 量化回测系统 - 任务清单（基于PRD需求）

> **最后更新**: 2024-09-03  
> **项目状态**: DCA策略完整联调阶段 - 专注主线打通前后端  
> **下一里程碑**: DCA策略完整用户流程验证，为下个策略积累经验

## 📋 **项目需求回顾（来自PRD.md）**

### 🎯 **核心目标**
- **产品定位**: 个人专用的量化交易策略回测验证平台，**专注ETF轮动等策略**的可行性验证
- **主要用户**: 具备Python编程能力的投资者，开发ETF轮动策略后进行历史数据验证
- **用户流程**: 策略选择页 → 参数配置页 → 回测执行页 → 结果展示页

### 📊 **PRD明确的功能需求**
- ✅ **多策略支持**: 定投、轮动、均值回归等多种预设策略
- ✅ **策略选择页**: 展示可用策略列表，策略简介，策略选择操作
- ✅ **动态参数配置**: 根据选择的策略动态生成参数表单
- ✅ **ETF轮动策略**: 支持月度/季度/年度轮动周期，可配置轮动的ETF池范围
- ✅ **详细回测报告**: 收益曲线、最大回撤、夏普比率、胜率等关键指标

### 🏗️ **技术架构需求**
- **后端**: Python + FastAPI + **Backtrader** + SQLite
- **前端**: React + TypeScript + Ant Design + ECharts  
- **数据源**: AKShare(A股) + yfinance(美股)

## 🔥 **重构背景**

2024-09-02 发现系统致命问题：
- ❌ **未使用Backtrader专业框架** - requirements.txt中被注释
- ❌ **自制SimpleBacktestEngine** - 功能有限，无法支持复杂策略
- ❌ **过度抽象 vs 功能缺失矛盾** - 抽象层复杂但核心功能不全

**解决方案**: 基于PRD需求，用Backtrader重建多策略回测系统

## ✅ **重构进展**

### 第一阶段：清理和重建基础 (2024-09-02 已完成)
- [x] **删除旧的后端代码**
  - [x] 删除自制的SimpleBacktestEngine
  - [x] 删除过时的抽象层
- [x] **重建项目基础**  
  - [x] 创建新的模块化架构
  - [x] 启用 backtrader==1.9.78.123 依赖
  - [x] 建立数据模型基础
- [x] **文档修正**
  - [x] 修正TODO.md与PRD.md保持一致
  - [x] 更新项目状态

### 第二阶段：架构修复和DCA策略实现 (2024-09-02 已完成)
- [x] **修复架构问题** 
  - [x] 解决Pydantic字段名冲突（date: date → trading_date: date）
  - [x] 解决bt.Strategy和ABC元类冲突问题
  - [x] 重构导入结构，解决循环导入问题
  - [x] 修复枚举类型和参数验证错误
- [x] **实现核心组件**
  - [x] 创建BaseStrategy基类（基于Backtrader）
  - [x] 实现StrategyRegistry策略注册管理器
  - [x] 完成DCA定投策略实现
  - [x] 创建策略和回测API接口
- [x] **验证系统功能**
  - [x] FastAPI服务正常启动（端口8008）
  - [x] DCA策略成功注册到系统
  - [x] 策略列表和详情API正常工作
  - [x] 系统架构验证完成

## 📋 **当前任务（基于实际进度重新规划）**

### ⚠️ **现状清醒认知 (2024-09-03 更新)**
- **UI设计**: ✅ **忍者黑客终端风格完成** - 已实现完整设计体系和规范
- **DCA策略**: 后端实现完成，但**前端完全未联动** - 仍在自嗨阶段  
- **数据源**: 使用假数据，AKShare未集成 - 无法真实回测
- **UI联动**: 零验证，前后端数据流未打通

### ✅ **UI设计阶段：忍者黑客风格完成** (2024-09-03)
- [x] **完成忍者黑客终端UI设计** `已完成` 
  - [x] 终端黑绿配色风格实现
  - [x] 打字机slogan效果（使用react-simple-typewriter）
  - [x] 忍者主题文案设计（"别人恐惧我贪婪，别人小亏我破产"）
  - [x] 品牌标题更新（Ninja韭菜道场@v2.0）
  - [x] 完整设计规范文档（DESIGN_SPEC.md）
  - [x] JSDoc注释规范和硬编码标记完成

### 🎯 **第三阶段：DCA策略完整联调** (当前阶段 🔥 - 2024-09-03 启动)

**策略独立开发模式**: 专注DCA策略完整实现，为后续策略积累经验和抽象模式

#### 📝 文档先行更新 (优先完成)
- [🔄] **更新TODO.md任务规划** `进行中`
  - [x] 调整ETF轮动策略到下个阶段
  - [x] 重新规划DCA专项联调任务
  - [ ] 添加策略独立开发模式说明
- [ ] **更新CLAUDE.md编码规则** `P0 最高优先级`
  - [ ] 添加策略独立开发模式规范
  - [ ] 增加抽象识别敏感度规则
  - [ ] 标记TODO_ABSTRACT注释规范
- [ ] **更新README.md品牌调性** `P1 中优先级`
  - [ ] 同步忍者黑客终端风格
  - [ ] 更新实际功能状态描述

#### 🔧 后端数据源集成
- [ ] **集成AKShare真实数据源** `P0 最高优先级` 
  - [ ] 安装和配置AKShare依赖
  - [ ] 实现数据获取和缓存机制
  - [ ] 替换DCA策略中的假数据源
  - [ ] 验证真实数据回测结果

#### 🎨 前端DCA页面重构
- [ ] **重构前端DCA页面适配忍者风格** `P0 最高优先级`
  - [ ] 创建frontend/src/pages/DCA/目录结构
  - [ ] 重构DCAConfig.tsx适配忍者黑客风格
  - [ ] 重构DCAResult.tsx适配忍者黑客风格
  - [ ] 创建DCA专用组件库

#### 🔗 完整前后端联调测试
- [ ] **DCA策略完整前后端联调验证** `P0 最高优先级`
  - [ ] 验证策略列表API与前端展示
  - [ ] 验证参数配置API与动态表单
  - [ ] 验证回测执行API与进度反馈
  - [ ] 测试完整的用户流程（选择→配置→执行→查看结果）
  - [ ] 错误处理和边界情况验证

### 📊 **第四阶段：ETF轮动策略开发** (下个阶段 - DCA完成后启动)

**基于DCA经验的策略独立开发模式**:
- [ ] **实现ETF轮动策略后端逻辑** `下个阶段P0` (PRD核心需求)
  - [ ] 基于Backtrader实现轮动策略
  - [ ] 支持月度/季度/年度轮动周期
  - [ ] ETF池配置和信号生成
  - [ ] 轮动策略专用API端点
- [ ] **ETF轮动前端页面开发** `下个阶段P0`
  - [ ] 创建frontend/src/pages/ETFRotation/目录
  - [ ] ETF轮动参数配置页面（忍者风格）
  - [ ] ETF轮动结果展示页面
  - [ ] ETF轮动专用组件库
- [ ] **ETF轮动策略完整联调** `下个阶段P0`
  - [ ] 前后端联调测试
  - [ ] 完整用户流程验证
  - [ ] 与DCA策略对比测试

### 🎨 **第五阶段：UI优化和抽象重构** (后续规划)
- [ ] **优化前端策略选择页面UI** `P1 中优先级`
  - [ ] 策略卡片设计优化
  - [ ] 分类筛选界面改进
  - [ ] 策略详情展示完善
- [ ] **实现动态参数配置表单** `P1 中优先级` 
  - [ ] 基于策略元数据生成表单
  - [ ] 参数验证和错误提示
  - [ ] 预设模板选择功能
- [ ] **完善回测结果展示页面** `P1 中优先级`
  - [ ] ECharts图表集成
  - [ ] 关键指标仪表盘
  - [ ] 报告导出功能

### 🔧 **第五阶段：系统完善** (最终阶段)
- [ ] **回测报告和性能指标** `P1 中优先级`
  - [ ] 收益曲线图生成
  - [ ] 回撤分析和关键指标计算
  - [ ] 策略对比功能实现
- [ ] **系统稳定性优化** `P1 中优先级`
  - [ ] 错误处理完善
  - [ ] 异步任务管理
  - [ ] 性能优化和用户体验提升

## 🎯 **策略独立开发模式设计原则** (2024-09-03 新增)

### 🎮 策略独立开发哲学
- **先具体后抽象**: 每个策略独立开发，积累3+策略后再抽象共性
- **专用体验优先**: 每个策略都有最优化的用户体验，避免通用性牺牲易用性  
- **抽象识别敏感度**: 开发时主动识别可抽象代码，标记`TODO_ABSTRACT`注释
- **经验积累导向**: DCA策略作为第一个完整案例，为后续策略提供开发模式

### 📋 编码抽象识别规范
开发时**提前识别**可能重复的代码模式，**主动询问**用户是否需要抽象，避免后续多次重复提醒。

**交互模式**: 
- 写代码时发现潜在重复模式 → 立即询问用户意见
- 用户决定后按要求执行，不再重复提醒
- 用`TODO_ABSTRACT: 描述`注释标记待抽象代码（如需要）

### 🎯 技术架构原则
- **Backtrader为核心**: 所有策略基于专业框架实现
- **策略专用设计**: 每个策略独立页面+独立API+独用组件
- **前后端分离**: 支持PRD定义的页面交互流程
- **忍者黑客风格**: 所有新页面都遵循忍者终端设计规范

### 数据和性能
- **免费数据源**: AKShare + yfinance (PRD第118-121行)
- **性能要求**: 单次回测 < 5分钟 (PRD第147行)
- **SQLite存储**: MVP阶段使用 (PRD第114行)

## 🎯 **当前系统状态**

### ✅ **已验证可用功能** (2024-09-02)
- **后端服务**: FastAPI运行在 http://localhost:8008
- **策略管理**: DCA定投策略已注册并可用
- **API接口**: 策略列表、详情、参数获取API正常工作
- **数据模型**: 完整的策略元数据和参数定义系统
- **Backtrader集成**: 基础架构已就位

### 🔧 **已修复的关键问题**
1. **Pydantic字段冲突**: `date: date` → `trading_date: date`
2. **元类冲突**: 创建`BaseStrategyMeta`解决bt.Strategy+ABC冲突
3. **循环导入**: 改为延迟注册策略避免导入循环
4. **类型验证**: 修复`ParameterOption.value`类型和枚举引用

## 🚀 **立即行动计划 - DCA策略专项联调** (2024-09-03)

### 📝 微任务执行模式
**重要**: 每完成一个小任务后立即停下和用户沟通，避免埋头苦干偏离方向

### 🎯 今日任务列表 (2024-09-03)
1. ✅ **更新TODO.md文档规划** - 调整任务优先级，专注DCA主线
2. 📋 **更新CLAUDE.md编码规则** - 添加策略独立开发模式规范
3. 📋 **更新README.md品牌调性** - 同步忍者黑客终端风格  
4. 🔧 **集成AKShare数据源** - 替换假数据，获取真实市场数据
5. 🎨 **重构前端DCA页面** - 适配忍者风格，创建专用目录结构
6. 🔗 **DCA策略完整联调测试** - 验证API能否正确驱动前端

### 🎯 DCA策略完整里程碑 (本周目标)
- **M1**: 文档完全同步，开发规范明确 ✅
- **M2**: DCA策略使用真实数据完成回测
- **M3**: DCA前端页面完整适配忍者风格  
- **M4**: DCA前后端完整联调，用户流程打通
- **M5**: DCA策略达到可演示状态，积累开发经验

### 📊 下个阶段预告
- **ETF轮动策略开发**: 基于DCA积累的经验和抽象模式
- **策略共性抽象**: 当有2-3个策略后，开始抽象重构
- **通用功能开发**: 基于真实需求设计通用组件和API

---

## ⚠️ **重要提醒**

**以PRD.md为准**: 所有功能实现都必须符合PRD.md中的明确需求
- PRD第19行: 策略选择页（可用策略**列表**）
- PRD第62行: ETF轮动策略配置轮动周期
- PRD第132行: 多种预设策略（定投、轮动、均值回归等）

**文档先行**: 任何架构变更都必须先更新文档，确保与PRD保持一致

**快速指令**:
查看完整需求请阅读 `PRD.md`
查看项目状态请阅读 `CLAUDE.md`