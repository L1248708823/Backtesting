# 量化回测系统 - 任务清单（基于PRD需求）

> **最后更新**: 2024-09-03  
> **项目状态**: 前端UI/UX优化阶段 - 现代化设计和用户体验提升  
> **下一里程碑**: 完整用户流程打通和ETF轮动策略实现

## 📋 **项目需求回顾（来自PRD.md）**

### 🎯 **核心目标**
- **产品定位**: 个人专用的量化交易策略回测验证平台，**专注ETF轮动等策略**的可行性验证
- **主要用户**: 具备Python编程能力的投资者，开发ETF轮动策略后进行历史数据验证
- **用户流程**: 策略选择页 → 参数配置页 → 回测执行页 → 结果展示页

### 📊 **PRD明确的功能需求**
- ✅ **多策略支持**: 定投、轮动、均值回归等多种预设策略
- ✅ **策略选择页**: 展示可用策略列表，策略简介，策略选择操作
- ✅ **动态参数配置**: 根据选择的策略动态生成参数表单
- ✅ **ETF轮动策略**: 支持月度/季度/年度轮动周期，可配置轮动的ETF池范围
- ✅ **详细回测报告**: 收益曲线、最大回撤、夏普比率、胜率等关键指标

### 🏗️ **技术架构需求**
- **后端**: Python + FastAPI + **Backtrader** + SQLite
- **前端**: React + TypeScript + Ant Design + ECharts  
- **数据源**: AKShare(A股) + yfinance(美股)

## 🔥 **重构背景**

2024-09-02 发现系统致命问题：
- ❌ **未使用Backtrader专业框架** - requirements.txt中被注释
- ❌ **自制SimpleBacktestEngine** - 功能有限，无法支持复杂策略
- ❌ **过度抽象 vs 功能缺失矛盾** - 抽象层复杂但核心功能不全

**解决方案**: 基于PRD需求，用Backtrader重建多策略回测系统

## ✅ **重构进展**

### 第一阶段：清理和重建基础 (2024-09-02 已完成)
- [x] **删除旧的后端代码**
  - [x] 删除自制的SimpleBacktestEngine
  - [x] 删除过时的抽象层
- [x] **重建项目基础**  
  - [x] 创建新的模块化架构
  - [x] 启用 backtrader==1.9.78.123 依赖
  - [x] 建立数据模型基础
- [x] **文档修正**
  - [x] 修正TODO.md与PRD.md保持一致
  - [x] 更新项目状态

### 第二阶段：架构修复和DCA策略实现 (2024-09-02 已完成)
- [x] **修复架构问题** 
  - [x] 解决Pydantic字段名冲突（date: date → trading_date: date）
  - [x] 解决bt.Strategy和ABC元类冲突问题
  - [x] 重构导入结构，解决循环导入问题
  - [x] 修复枚举类型和参数验证错误
- [x] **实现核心组件**
  - [x] 创建BaseStrategy基类（基于Backtrader）
  - [x] 实现StrategyRegistry策略注册管理器
  - [x] 完成DCA定投策略实现
  - [x] 创建策略和回测API接口
- [x] **验证系统功能**
  - [x] FastAPI服务正常启动（端口8008）
  - [x] DCA策略成功注册到系统
  - [x] 策略列表和详情API正常工作
  - [x] 系统架构验证完成

## 📋 **当前任务（严格按照PRD需求）**

### 🎯 **第三阶段：回测功能完善** (当前阶段)
- [x] **策略选择系统** `P0 高优先级` (PRD第19行要求)
  - [x] 策略注册和发现机制 ✅
  - [x] 策略元数据定义（名称、描述、风险等级）✅
  - [x] 策略分类和筛选系统 ✅
- [x] **动态参数配置系统** `P0 高优先级` (PRD第38-39行要求)  
  - [x] 策略参数定义框架 ✅
  - [x] 参数验证和预设模板 ✅
  - [x] 前端动态表单生成支持 ✅
- [x] **Backtrader集成架构** `P0 高优先级`
  - [x] 统一的Backtrader策略基类 ✅
  - [ ] 数据源管理 (AKShare + yfinance) 🚧 待完成
  - [x] 回测引擎封装 ✅

### 🔧 **第三阶段：核心策略实现** (待启动)
- [ ] **ETF轮动策略实现** `P0 高优先级` (PRD第62行明确要求)
  - [ ] 基于Backtrader实现轮动逻辑
  - [ ] 支持月度/季度/年度轮动周期
  - [ ] ETF池配置和动态调整
  - [ ] 轮动信号生成和执行
- [ ] **DCA定投策略实现** `P0 高优先级`
  - [ ] 基于Backtrader实现定投逻辑
  - [ ] 定投频率和金额配置
  - [ ] 节假日处理和智能调整
- [ ] **回测执行系统** `P0 高优先级`
  - [ ] 异步回测任务管理
  - [ ] 实时进度反馈
  - [ ] 错误处理和任务取消

### 📊 **第四阶段：结果展示系统** (规划中)
- [ ] **详细回测报告** `P0 高优先级` (PRD第22行要求)
  - [ ] 收益曲线图生成
  - [ ] 回撤分析和可视化
  - [ ] 夏普比率等关键指标计算
- [ ] **多维度分析** `P1 中优先级`
  - [ ] 策略对比功能 (最多3个结果同时对比)
  - [ ] 参数敏感性分析
  - [ ] 风险指标详细展示

### 🔌 **第五阶段：前端集成** (规划中)
- [ ] **策略选择页面** `P0 高优先级` (PRD明确的P0页面)
  - [ ] 策略卡片展示
  - [ ] 策略详情弹窗
  - [ ] 分类筛选功能
- [ ] **参数配置页面** `P0 高优先级` (PRD明确的P0页面)
  - [ ] 动态参数表单
  - [ ] 参数验证和提示
  - [ ] 预设模板选择
- [ ] **回测执行和结果页面** `P0 高优先级`
  - [ ] 实时进度显示
  - [ ] 结果图表展示
  - [ ] 报告导出功能

## 🎯 **设计原则（基于PRD约束）**

### 功能完备性优先
- **多策略支持**: 满足PRD中明确的策略需求
- **专业回测**: 基于Backtrader确保结果准确性
- **用户体验**: 符合PRD中定义的用户流程

### 技术架构原则
- **Backtrader为核心**: 所有策略基于专业框架实现
- **模块化设计**: 支持策略扩展，但避免过度抽象
- **前后端分离**: 支持PRD定义的页面交互流程

### 数据和性能
- **免费数据源**: AKShare + yfinance (PRD第118-121行)
- **性能要求**: 单次回测 < 5分钟 (PRD第147行)
- **SQLite存储**: MVP阶段使用 (PRD第114行)

## 🎯 **当前系统状态**

### ✅ **已验证可用功能** (2024-09-02)
- **后端服务**: FastAPI运行在 http://localhost:8008
- **策略管理**: DCA定投策略已注册并可用
- **API接口**: 策略列表、详情、参数获取API正常工作
- **数据模型**: 完整的策略元数据和参数定义系统
- **Backtrader集成**: 基础架构已就位

### 🔧 **已修复的关键问题**
1. **Pydantic字段冲突**: `date: date` → `trading_date: date`
2. **元类冲突**: 创建`BaseStrategyMeta`解决bt.Strategy+ABC冲突
3. **循环导入**: 改为延迟注册策略避免导入循环
4. **类型验证**: 修复`ParameterOption.value`类型和枚举引用

## 🚀 **下一步行动**

### 立即可开始 (今天)
1. **测试DCA策略回测** - 调用回测API验证完整流程
2. **实现数据源集成** - 接入AKShare获取真实数据
3. **完善错误处理** - 提升API稳定性

### 本周目标 (2024-09-02 - 2024-09-08)
- [ ] 完成DCA策略回测验证
- [ ] 实现数据源管理（AKShare集成）
- [ ] 实现ETF轮动策略
- [ ] 前端页面对接测试

### 里程碑验证
- **M1**: ETF轮动策略能够执行完整回测
- **M2**: 策略选择页面能够展示多个策略
- **M3**: 参数配置能够根据策略动态生成
- **M4**: 前端能够完整走通PRD定义的用户流程

---

## ⚠️ **重要提醒**

**以PRD.md为准**: 所有功能实现都必须符合PRD.md中的明确需求
- PRD第19行: 策略选择页（可用策略**列表**）
- PRD第62行: ETF轮动策略配置轮动周期
- PRD第132行: 多种预设策略（定投、轮动、均值回归等）

**文档先行**: 任何架构变更都必须先更新文档，确保与PRD保持一致

**快速指令**:
查看完整需求请阅读 `PRD.md`
查看项目状态请阅读 `CLAUDE.md`