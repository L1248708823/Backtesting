# 量化回测系统 - 任务清单（基于PRD需求）

> **最后更新**: 2024-09-04  
> **项目状态**: DCA终端UI完善阶段 - 忍者黑客风格界面优化完成  
> **下一里程碑**: 后端数据源集成，DCA策略前后端完整联调

## 📋 **项目需求回顾（来自PRD.md）**

### 🎯 **核心目标**
- **产品定位**: 个人专用的量化交易策略回测验证平台，**专注ETF轮动等策略**的可行性验证
- **主要用户**: 具备Python编程能力的投资者，开发ETF轮动策略后进行历史数据验证
- **用户流程**: 策略选择页 → 参数配置页 → 回测执行页 → 结果展示页

### 📊 **PRD明确的功能需求**
- ✅ **多策略支持**: 定投、轮动、均值回归等多种预设策略
- ✅ **策略选择页**: 展示可用策略列表，策略简介，策略选择操作
- ✅ **动态参数配置**: 根据选择的策略动态生成参数表单
- ✅ **ETF轮动策略**: 支持月度/季度/年度轮动周期，可配置轮动的ETF池范围
- ✅ **详细回测报告**: 收益曲线、最大回撤、夏普比率、胜率等关键指标

### 🏗️ **技术架构需求**
- **后端**: Python + FastAPI + **Backtrader** + SQLite
- **前端**: React + TypeScript + Ant Design + ECharts  
- **数据源**: AKShare(A股) + yfinance(美股)

## 🔥 **重构背景**

2024-09-02 发现系统致命问题：
- ❌ **未使用Backtrader专业框架** - requirements.txt中被注释
- ❌ **自制SimpleBacktestEngine** - 功能有限，无法支持复杂策略
- ❌ **过度抽象 vs 功能缺失矛盾** - 抽象层复杂但核心功能不全

**解决方案**: 基于PRD需求，用Backtrader重建多策略回测系统

## ✅ **重构进展**

### 第一阶段：清理和重建基础 (2024-09-02 已完成)
- [x] **删除旧的后端代码**
  - [x] 删除自制的SimpleBacktestEngine
  - [x] 删除过时的抽象层
- [x] **重建项目基础**  
  - [x] 创建新的模块化架构
  - [x] 启用 backtrader==1.9.78.123 依赖
  - [x] 建立数据模型基础
- [x] **文档修正**
  - [x] 修正TODO.md与PRD.md保持一致
  - [x] 更新项目状态

### 第二阶段：架构修复和DCA策略实现 (2024-09-02 已完成)
- [x] **修复架构问题** 
  - [x] 解决Pydantic字段名冲突（date: date → trading_date: date）
  - [x] 解决bt.Strategy和ABC元类冲突问题
  - [x] 重构导入结构，解决循环导入问题
  - [x] 修复枚举类型和参数验证错误
- [x] **实现核心组件**
  - [x] 创建BaseStrategy基类（基于Backtrader）
  - [x] 实现StrategyRegistry策略注册管理器
  - [x] 完成DCA定投策略实现
  - [x] 创建策略和回测API接口
- [x] **验证系统功能**
  - [x] FastAPI服务正常启动（端口8008）
  - [x] DCA策略成功注册到系统
  - [x] 策略列表和详情API正常工作
  - [x] 系统架构验证完成

## 📋 **当前任务（基于实际进度重新规划）**

### ⚠️ **现状清醒认知 (2024-09-03 更新)**
- **UI设计**: ✅ **忍者黑客终端风格完成** - 已实现完整设计体系和规范
- **DCA策略**: 后端实现完成，但**前端完全未联动** - 仍在自嗨阶段  
- **数据源**: 使用假数据，AKShare未集成 - 无法真实回测
- **UI联动**: 零验证，前后端数据流未打通

### ✅ **UI设计阶段：忍者黑客风格完成** (2024-09-03)
- [x] **完成忍者黑客终端UI设计** `已完成` 
  - [x] 终端黑绿配色风格实现
  - [x] 打字机slogan效果（使用react-simple-typewriter）
  - [x] 忍者主题文案设计（"别人恐惧我贪婪，别人小亏我破产"）
  - [x] 品牌标题更新（Ninja韭菜道场@v2.0）
  - [x] 完整设计规范文档（DESIGN_SPEC.md）
  - [x] JSDoc注释规范和硬编码标记完成

### 🎯 **第三阶段：DCA策略完整联调** (当前阶段 🔥 - 2024-09-03 启动)

**策略独立开发模式**: 专注DCA策略完整实现，为后续策略积累经验和抽象模式

#### 📝 文档先行更新 (优先完成)
- [🔄] **更新TODO.md任务规划** `进行中`
  - [x] 调整ETF轮动策略到下个阶段
  - [x] 重新规划DCA专项联调任务
  - [ ] 添加策略独立开发模式说明
- [ ] **更新CLAUDE.md编码规则** `P0 最高优先级`
  - [ ] 添加策略独立开发模式规范
  - [ ] 增加抽象识别敏感度规则
  - [ ] 标记TODO_ABSTRACT注释规范
- [ ] **更新README.md品牌调性** `P1 中优先级`
  - [ ] 同步忍者黑客终端风格
  - [ ] 更新实际功能状态描述

#### ✅ 后端数据源集成 (已完成 2024-09-03)
- [x] **集成AKShare真实数据源** `已完成`
  - [x] 删除所有假数据fallback机制 
  - [x] data_manager使用真实数据或直接报错
  - [x] DCA策略已使用真实数据回测
  - [x] 验证510300 ETF真实数据回测成功（-12.10%收益）

### ✅ 前端DCA页面重构 (已完成 2024-09-03) 
- [x] **重构前端DCA页面适配忍者风格** `已完成`
  - [x] 创建frontend/src/pages/DCA/目录结构
  - [x] 重构DCAConfig.tsx忍者黑客终端风格
  - [x] 重构DCAResult.tsx忍者黑客终端风格  
  - [x] 创建DCA专用组件库(ETFSelector, FrequencySelect, ParameterPreview)

### ✅ 完整前后端联调测试 (已完成 2024-09-03)
- [x] **DCA策略完整前后端联调验证** `已完成`
  - [x] 修复API调用使用通用接口 /api/v1/backtest/run
  - [x] 验证回测结果正确传递到结果页面
  - [x] 后端服务: http://localhost:8008 ✅运行中
  - [x] 前端服务: http://localhost:3001 ✅运行中  
  - [x] curl测试通过: DCA策略回测成功返回完整结果

### 📊 **第四阶段：ETF轮动策略开发** (下个阶段 - DCA完成后启动)

**基于DCA经验的策略独立开发模式**:
- [ ] **实现ETF轮动策略后端逻辑** `下个阶段P0` (PRD核心需求)
  - [ ] 基于Backtrader实现轮动策略
  - [ ] 支持月度/季度/年度轮动周期
  - [ ] ETF池配置和信号生成
  - [ ] 轮动策略专用API端点
- [ ] **ETF轮动前端页面开发** `下个阶段P0`
  - [ ] 创建frontend/src/pages/ETFRotation/目录
  - [ ] ETF轮动参数配置页面（忍者风格）
  - [ ] ETF轮动结果展示页面
  - [ ] ETF轮动专用组件库
- [ ] **ETF轮动策略完整联调** `下个阶段P0`
  - [ ] 前后端联调测试
  - [ ] 完整用户流程验证
  - [ ] 与DCA策略对比测试

### 🎨 **第五阶段：UI优化和抽象重构** (后续规划)
- [ ] **优化前端策略选择页面UI** `P1 中优先级`
  - [ ] 策略卡片设计优化
  - [ ] 分类筛选界面改进
  - [ ] 策略详情展示完善
- [ ] **实现动态参数配置表单** `P1 中优先级` 
  - [ ] 基于策略元数据生成表单
  - [ ] 参数验证和错误提示
  - [ ] 预设模板选择功能
- [ ] **完善回测结果展示页面** `P1 中优先级`
  - [ ] ECharts图表集成
  - [ ] 关键指标仪表盘
  - [ ] 报告导出功能

### 🔧 **第五阶段：系统完善** (最终阶段)
- [ ] **回测报告和性能指标** `P1 中优先级`
  - [ ] 收益曲线图生成
  - [ ] 回撤分析和关键指标计算
  - [ ] 策略对比功能实现
- [ ] **系统稳定性优化** `P1 中优先级`
  - [ ] 错误处理完善
  - [ ] 异步任务管理
  - [ ] 性能优化和用户体验提升

## 🎯 **策略独立开发模式设计原则** (2024-09-03 新增)

### 🎮 策略独立开发哲学
- **先具体后抽象**: 每个策略独立开发，积累3+策略后再抽象共性
- **专用体验优先**: 每个策略都有最优化的用户体验，避免通用性牺牲易用性  
- **抽象识别敏感度**: 开发时主动识别可抽象代码，标记`TODO_ABSTRACT`注释
- **经验积累导向**: DCA策略作为第一个完整案例，为后续策略提供开发模式

### 📋 编码抽象识别规范
开发时**提前识别**可能重复的代码模式，**主动询问**用户是否需要抽象，避免后续多次重复提醒。

**交互模式**: 
- 写代码时发现潜在重复模式 → 立即询问用户意见
- 用户决定后按要求执行，不再重复提醒
- 用`TODO_ABSTRACT: 描述`注释标记待抽象代码（如需要）

### 🎯 技术架构原则
- **Backtrader为核心**: 所有策略基于专业框架实现
- **策略专用设计**: 每个策略独立页面+独立API+独用组件
- **前后端分离**: 支持PRD定义的页面交互流程
- **忍者黑客风格**: 所有新页面都遵循忍者终端设计规范

### 数据和性能
- **免费数据源**: AKShare + yfinance (PRD第118-121行)
- **性能要求**: 单次回测 < 5分钟 (PRD第147行)
- **SQLite存储**: MVP阶段使用 (PRD第114行)

## 🎯 **当前系统状态**

### ✅ **已验证可用功能** (2024-09-02)
- **后端服务**: FastAPI运行在 http://localhost:8008
- **策略管理**: DCA定投策略已注册并可用
- **API接口**: 策略列表、详情、参数获取API正常工作
- **数据模型**: 完整的策略元数据和参数定义系统
- **Backtrader集成**: 基础架构已就位

### 🔧 **已修复的关键问题**
1. **Pydantic字段冲突**: `date: date` → `trading_date: date`
2. **元类冲突**: 创建`BaseStrategyMeta`解决bt.Strategy+ABC冲突
3. **循环导入**: 改为延迟注册策略避免导入循环
4. **类型验证**: 修复`ParameterOption.value`类型和枚举引用

## 🚀 **立即行动计划 - DCA策略专项联调** (2024-09-03)

### 📝 微任务执行模式
**重要**: 每完成一个小任务后立即停下和用户沟通，避免埋头苦干偏离方向

### ✅ DCA策略联调完成状态 (2024-09-03)
1. ✅ **更新TODO.md文档规划** - 已完成
2. ✅ **更新CLAUDE.md编码规则** - 已完成
3. ✅ **更新README.md品牌调性** - 已完成  
4. ✅ **集成AKShare数据源** - 已完成，删除假数据fallback
5. ✅ **重构前端DCA页面** - 忍者终端风格完成
6. ✅ **DCA策略完整联调测试** - 前后端完全打通

### 🎯 DCA策略里程碑达成情况 ✅
- **M1**: ✅ 文档完全同步，开发规范明确  
- **M2**: ✅ DCA策略使用真实数据完成回测（510300 ETF）
- **M3**: ✅ DCA前端页面完整适配忍者风格   
- **M4**: ✅ DCA前后端完整联调，用户流程打通
- **M5**: ✅ DCA策略达到可演示状态，积累开发经验

## 🔥 **重启后待测试项 (2024-09-03)**

### 📱 用户完整流程验证 (重启后必测)
1. **访问主页**: http://localhost:3001 
2. **选择DCA策略**: 点击进入DCA定投策略
3. **配置参数**: 选择标的、金额、频率、时间范围
4. **执行回测**: 提交后端API调用
5. **查看结果**: 跳转结果页面显示完整报告

### 🚀 服务启动命令 (重启必用)
```bash
# 后端启动 (端口8008)
cd "E:\py\cc 回测\backend" && py -3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8008

# 前端启动 (可能端口3001，如3000被占用)  
cd "E:\py\cc 回测\frontend" && npm run dev
```

### 🧪 技术验证命令 (重启后可测)
```bash
# 测试DCA策略API
curl -X POST "http://localhost:8008/api/v1/backtest/run" \
  -H "Content-Type: application/json" \
  -d "{\"strategy_id\":\"dca_strategy\",\"parameters\":{\"investment_amount\":1000,\"frequency_days\":30,\"symbol\":\"510300\"},\"start_date\":\"2023-01-01\",\"end_date\":\"2023-12-31\",\"initial_cash\":10000}"
```

## 🎯 **下个阶段规划 (DCA完成后)**

### 📊 下个阶段预告
- **ETF轮动策略开发**: 基于DCA积累的经验和抽象模式
- **策略共性抽象**: 当有2-3个策略后，开始抽象重构

### 🏆 **DCA策略经验总结 (for下个策略)**
1. **策略独立开发模式验证成功** ✅
   - 专用目录结构: `/pages/DCA/` + `components/`
   - 专用API设计: 通用回测接口 + 策略特定参数
   - 忍者黑客终端UI风格统一
   
2. **技术架构模式确立** ✅
   - Backtrader + FastAPI后端架构稳定
   - React + TypeScript前端组件化
   - 路由状态传递回测结果方案
   
3. **抽象候选识别** 🔍
   - 回测结果展示组件 (performance metrics display)
   - 参数配置预览组件 (parameter preview)  
   - 忍者终端UI样式组件 (terminal styling)
   - 策略选择卡片组件 (strategy cards)
- **通用功能开发**: 基于真实需求设计通用组件和API

---

## 🎯 **2024-09-04 工作总结**

### ✅ 今日完成的重大改进
1. **DCA终端UI界面完善** ✅
   - 修复 react-simple-typewriter 打字机效果，实现终端累积显示
   - 解决 InputNumber 组件白色背景问题（addonAfter 导致的样式冲突）
   - 优化用户流程，去掉不必要的确认步骤（配置 → 直接执行）
   - 完善 ASCII 艺术终端卡片设计，保持黑客忍者风格一致性

2. **技术问题深度排查** ✅
   - 分析 Ant Design InputNumber 组件结构，找到样式覆盖根本原因
   - 学习先分析后解决的专业调试方法，避免盲目"暴力修复"
   - 理解 addonAfter 属性对组件 DOM 结构的影响

### 🔧 明日待办 (按优先级排序)
1. **后端数据源集成** 🔥
   - 集成 AKShare 真实A股数据，替换假数据
   - 测试 510300 等ETF真实历史数据获取
   - 验证数据格式与 Backtrader 兼容性

2. **DCA前后端完整联调** 🔥
   - 测试完整用户流程：选择→配置→执行→结果
   - 验证前端参数正确传递给后端API
   - 确认回测结果正确返回并展示

3. **用户体验优化** ⭐
   - 添加执行过程中的loading状态
   - 优化错误处理和提示信息
   - 测试各种边界情况和异常场景

### 📋 当前技术状态
- **前端**: React + 忍者终端UI完成，DCA配置页面功能齐全
- **后端**: Backtrader + FastAPI架构稳定，DCA策略实现完成
- **数据源**: 需要集成 AKShare，当前使用模拟数据
- **联调状态**: 等待数据源集成后进行端到端测试

### 🚀 快速重启指令 (明日使用)
```bash
# 后端启动 (记得集成AKShare后重启)
cd "E:\py\cc 回测\backend" && py -3 -m uvicorn app.main:app --reload --port 8008

# 前端启动 (当前在3001端口)
cd "E:\py\cc 回测\frontend" && npm run dev -- --port 3001
```

### 💡 明日重点
专注于**数据源集成**和**完整联调**，确保DCA策略端到端工作，为后续ETF轮动策略开发奠定基础。

---

## ⚠️ **重要提醒**

**以PRD.md为准**: 所有功能实现都必须符合PRD.md中的明确需求
- PRD第19行: 策略选择页（可用策略**列表**）
- PRD第62行: ETF轮动策略配置轮动周期
- PRD第132行: 多种预设策略（定投、轮动、均值回归等）

**文档先行**: 任何架构变更都必须先更新文档，确保与PRD保持一致

**快速指令**:
查看完整需求请阅读 `PRD.md`
查看项目状态请阅读 `CLAUDE.md`