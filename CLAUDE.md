# Claude 项目上下文 - 量化回测系统
> **文件别名**: 项目大脑.md / AI记忆库.md (中文友好称呼)

<!-- ============================================================================
🔄 通用AI工作规范区域 (可迁移到其他项目)
这些规则适用于任何项目的AI助手工作模式，具有通用性
============================================================================ -->

## 🔝 **核心工作规范** (P0最高优先级)

### 🌟 **基础交互原则**
- 每次都用中文回复
- 每次都用审视的目光，仔细看我输入的潜在问题。你要指出我的问题，并给出明显在我思考框架之外的建议。如果你觉得我说的太离谱了，你就女生方式可爱的骂回来，帮我瞬间清醒；
- **微任务沟通原则**: 完成TODO中的一小项任务后及时暂停和用户沟通，避免一口气埋头苦干，保持互动节奏和方向确认
- **TODO文件同步**: 每次任务规划变更必须及时更新TODO.md文件，避免中途退出或遗忘导致状态不一致
- **⚠️ TODO更新原则**: 更新TODO.md时，永远不要删除历史任务，应该标记完成状态([x])或添加新任务。TODO文档应保持完整的任务历史记录和追踪轨迹，这对项目管理和进度回顾至关重要

### 🔄 **开发模式识别与流程规范** 
**核心理念**: 区分初次接入和持续开发两种模式，确保组件复用和文档同步

#### 模式A: 初次接入系统 (第一次对话)
**强制流程** (P0最高优先级，不可跳过):
1. **系统全景了解**
   - 📋 **必读**: TODO.md (了解当前进度和待办任务)
   - 🧠 **必读**: CLAUDE.md (了解项目全貌和开发规范)  
   - 📄 **必读**: PRD.md (理解产品需求和架构决策)
   - 🏗️ **必读**: ARCHITECTURE_REGISTRY.md (掌握现有组件和工具)

2. **架构现状分析**
   - 检查服务运行状态和项目结构
   - 扫描关键代码文件了解实现现状
   - 确认当前开发阶段和优先任务

3. **开发计划制定**
   - 基于TODO.md确定下一步具体任务
   - 检查现有组件和工具的可复用性
   - 制定具体实施计划避免重复开发

#### 模式B: 持续开发 (N+1次对话)
**标准流程**:
1. **快速状态同步**
   - 检查TODO.md最新状态和进度变化
   - 回顾上次对话的工作成果和遗留问题
   - 确认当前模块的完成度和下一步计划

2. **模块完成检查点** ⚠️ **关键机制**
   - 每完成一个模块/功能后，**强制暂停**
   - 询问用户: "[模块名]已完成，涉及[具体变更]。是否需要先更新TODO.md状态再继续？"
   - 等待用户明确确认后再继续下个任务

3. **开发前组件复用检查**
   - 检查ARCHITECTURE_REGISTRY.md相关现有组件
   - 搜索现有代码避免重复实现
   - 发现重复代码立即询问用户是否需要抽象

#### 🛑 强制暂停询问机制
**触发暂停的情况**:
- ✅ 完成TODO.md中的任一任务项
- ✅ 创建新的service/API/component/hook
- ✅ 修复重要bug或解决架构问题
- ✅ 完成一个页面或功能模块
- ✅ 发现需要更新文档的情况

**标准询问模板**: "[具体完成内容]已完成。是否需要先更新TODO.md状态再继续？"

#### 🔍 组件复用强制检查规范
**任何开发前必须执行**:
1. 检查ARCHITECTURE_REGISTRY.md查找相关现有组件
2. 使用搜索扫描现有代码中的相似实现
3. 发现重复模式时立即询问用户是否需要抽象
4. 创建新工具/组件后立即更新架构清单文档

**违规警告系统**: 发现重复实现立即停止开发，提醒用户已有类似功能位置，建议复用或抽象方案

#### 📝 文档同步更新机制
**触发文档更新的情况**:
- 新增API service方法 → 更新ARCHITECTURE_REGISTRY.md
- 完成TODO任务项 → 更新TODO.md状态标记  
- 新增工具函数/常量 → 更新ARCHITECTURE_REGISTRY.md
- 修改架构设计决策 → 更新CLAUDE.md相应章节

**更新确认流程**: 每次文档更新后询问用户是否满意当前文档状态

<!-- ============================================================================
🎯 项目特定信息区域 (量化回测系统专用)
以下内容特定于当前项目，包含项目概述、架构决策、文件索引等
============================================================================ -->

## 🎯 **项目核心信息**

### 🎭 团队角色系统
我是项目的总设计师，拥有四名专业员工：
- **产品经理** - 负责需求分析和PRD文档 (已完成 ✅)
- **架构师** - 负责架构验证和细化设计 (已完成 ✅)
- **UI/UX设计师** - 负责设计规范和交互设计 (已完成 ✅)  
- **全栈开发工程师** - 负责前后端代码实现和技术交付 (进行中 🔥)

**团队指令系统**:
- `/产品` - 切换到产品经理角色
- `/架构` - 切换到架构师角色
- `/设计` - 切换到UI/UX设计师角色  
- `/开发` - 切换到前端开发工程师角色

### 📋 项目概述
- **项目名称**: 量化回测系统 (Quantitative Backtesting System)
- **目标**: 个人专用的ETF轮动等策略回测验证平台
- **用户**: 具备编程背景的个人投资者 + 程序员朋友
- **当前阶段**: DCA策略完成，准备开发ETF轮动策略 🔥

### 🚀 技术架构决策

#### 核心技术栈
- **项目结构**: Monorepo + 前后端分离
- **后端**: Python + FastAPI + Backtrader + SQLite
- **前端**: React + TypeScript + Ant Design + ECharts  
- **容器化**: Docker + Docker Compose
- **数据源**: AKShare(A股) + yfinance(美股) - 免费方案

#### 关键架构组件 (已完成)
- ✅ **策略注册系统**: `StrategyRegistry` 单例模式管理
- ✅ **统一数据源**: `DataManager` 抽象层自动选择数据源
- ✅ **API标准化**: 前后端类型完全统一，axios统一错误处理
- ✅ **忍者UI风格**: 黑绿终端风格，完整设计规范

### 📁 重要文件索引

#### 🧠 项目管理核心
- **`CLAUDE.md`** (本文件) - 项目上下文和AI工作规范 🧠
- **`TODO.md`** - 详细任务管理和进度跟踪 📋
- **`ARCHITECTURE_REGISTRY.md`** - 架构资产清单，避免重复开发 🏗️

#### 📄 核心文档
- `PRD.md` - 完整产品需求文档 📋
- `README.md` - 项目说明和忍者道场介绍 📖  
- `QUICKSTART.md` - 快速启动指南 🚀
- `docs/development.md` - 详细开发指南 🛠️

#### 🐳 配置文件
- `docker-compose.yml` - 容器编排配置
- `backend/requirements.txt` - Python依赖
- `frontend/package.json` - Node.js依赖

### 🎯 当前项目状态

#### 可启动功能
- ✅ **Docker 一键启动**: `docker-compose up -d`
- ✅ **API 服务**: http://localhost:8008 (FastAPI + Swagger文档)
- ✅ **Web 界面**: http://localhost:3001 (React + 忍者终端风格)
- ✅ **DCA策略**: 完整前后端联调，真实数据回测
- ✅ **类型系统**: 前后端类型完全统一，自动错误处理

#### 核心API (已实现)
- `/api/v1/strategies/` - 策略管理 (列表、详情、参数)
- `/api/v1/backtest/run` - 统一回测执行接口
- 专用DCA API: `backtestService.runDCABacktest()` - 简化调用

### 🎛️ 快速恢复指令

当用户下次对话时，我应该：
1. **读取项目上下文**: 先读取CLAUDE.md了解项目整体状态
2. **检查任务进度**: 必须读取TODO.md获取最新任务进度
3. **确认当前阶段**: 基于文档信息确定优先任务
4. **提供选择**: 
   - 继续开发ETF轮动策略 🔥 **推荐优先**
   - 或测试DCA策略完整流程
   - 或查看TODO.md中的具体任务列表

<!-- ============================================================================
📚 详细规范和项目历史区域
包含具体的开发规范、历史记录、技术约束等详细信息
============================================================================ -->

## 📚 **详细规范和历史记录**

### 🎯 策略独立开发模式规范
**核心原则**: 专注当前策略完整实现，避免过早抽象化

#### 开发策略
- **每个策略独立开发**: DCA、ETF轮动等策略都有独立页面+独立API+独立组件
- **专用体验优先**: 追求每个策略的最优用户体验，不为通用性牺牲易用性
- **先具体后抽象**: 完成2-3个策略后再考虑抽象共性，避免过早优化

#### 抽象识别交互模式
- **提前识别**: 写代码时发现潜在重复模式，立即询问用户是否需要抽象
- **一次决定**: 用户决定后按要求执行，不再重复提醒相同问题
- **标记待抽象**: 如需要，用`TODO_ABSTRACT: 描述`注释标记待抽象代码

#### 标准目录结构
```
frontend/src/
├── services/                # API服务层 (统一axios)
├── components/              # 全局通用组件
├── pages/                   # 页面组件
│   ├── StrategySelection/   # 策略选择页 (忍者风格)
│   ├── DCA/                 # DCA策略专用 ✅
│   │   ├── index.tsx
│   │   ├── DCAConfig.tsx    # 参数配置
│   │   ├── DCAResult.tsx    # 结果展示
│   │   └── components/      # DCA专用组件
│   └── ETFRotation/         # ETF轮动专用 (下个阶段)
└── utils/                   # 工具层 (constants.ts等)
```

### 🎯 代码注释和工作规范
**TypeScript/JavaScript注释规范**: 
- 所有接口定义(interface)必须有完整的JSDoc中文注释
- **所有React状态变量(useState)必须有JSDoc中文注释**
- 重要配置参数和选项必须有详细说明（取值范围、使用建议）
- 格式：`/** 参数说明 - 详细解释，包含取值范围和使用建议 */`
- 目的：方便在VSCode中hover查看，无需查找文档

**硬编码数据标记规范**:
- 所有写死的参数和数据必须添加TODO注释
- 格式：`/** TODO: 后期用什么数据替换的详细说明 */`

### ⚠️ 技术约束
- 使用免费数据源 (成本控制)
- 支持策略可配置但不支持在线编辑
- 暂不支持多用户系统
- MVP版本使用SQLite，后期可升级PostgreSQL

### 🖥️ 环境信息
- **用户系统**: Windows + PowerShell
- **我的运行环境**: WSL Ubuntu (注意命令差异！)
- **Python环境**: Python 3.13.3 (用 `py -3` 调用)
- **Node.js**: 18+ (已升级)

### 📊 项目发展历程 (关键里程碑)
- **2024-08-11**: 项目初始化 + 需求分析完成
- **2024-08-27**: 架构优化，类型统一系统建立
- **2024-09-02**: Backtrader重构，删除自制引擎  
- **2024-09-03**: 忍者UI风格完成 + DCA策略联调完成
- **2024-09-04**: API重构统一 + 开发流程规范建立

### 🏆 当前成就状态
- **需求clarity**: 95% (PRD完整) ✅
- **技术架构**: 95% (Backtrader + API重构完成) ✅  
- **DCA策略**: 95% (完整前后端联调) ✅
- **UI设计**: 95% (忍者黑客风格完整) ✅
- **数据源**: 90% (AKShare集成完成) ✅
- **文档体系**: 95% (四大文档完整) ✅

---
**最后更新**: 2024-09-04  
**当前责任人**: 总设计师 → ETF轮动策略开发阶段 🔥  
**下一里程碑**: ETF轮动策略完整实现，积累多策略抽象经验