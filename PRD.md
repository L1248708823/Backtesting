# 产品需求文档（Product Requirements Document）

## 1. 产品概述
- **产品名称**：量化回测系统（Quantitative Backtesting System）
- **产品定位**：个人专用的量化交易策略回测验证平台，专注ETF轮动等策略的可行性验证
- **目标用户**：个人投资者（具备编程背景）、程序员朋友（二次开发者）
- **核心问题**：解决个人投资者缺乏专业回测工具验证交易策略有效性的问题

## 2. 用户分析
| 用户类型 | 用户特征 | 核心需求 | 使用场景 |
|:--------:|:--------:|:--------:|:--------:|
| 策略开发者（主要用户） | 具备Python编程能力，量化投资初学者 | 验证自研策略、配置灵活参数、查看详细回测报告 | 开发ETF轮动策略后进行历史数据验证 |
| 程序员朋友（次要用户） | 有编程背景但量化经验较少 | 使用现成策略、理解回测逻辑、参数调优 | 体验量化回测、学习策略思路 |

## 3. 页面架构
### 3.1 页面清单
| 页面名称 | 页面类型 | 核心功能 | 用户价值 | 用户入口 | 优先级 |
|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|
| 策略选择页 | 主页 | 展示可用策略列表，策略简介 | 快速了解和选择合适策略 | 系统首页 | P0 |
| 参数配置页 | 功能页 | 策略参数设置、回测时间配置 | 灵活调整策略参数进行测试 | 选择策略后跳转 | P0 |
| 回测执行页 | 流程页 | 显示回测进度、实时状态更新 | 了解回测进展，避免长时间等待焦虑 | 提交参数后自动跳转 | P0 |
| 结果展示页 | 功能页 | 回测报告、图表分析、关键指标 | 全面分析策略表现和风险特征 | 回测完成后跳转 | P0 |
| 策略管理页 | 功能页 | 策略代码查看、历史回测记录 | 管理策略版本和回测历史 | 导航栏入口 | P1 |
| 数据管理页 | 功能页 | 数据源状态、数据更新日志 | 监控数据质量，确保回测准确性 | 导航栏入口 | P1 |

### 3.2 页面详细需求

#### 页面1：策略选择页
- **页面目标**：帮助用户快速了解和选择适合的回测策略
- **核心功能**：策略列表展示、策略详情介绍、策略选择操作
- **业务逻辑**：展示所有可用策略，每个策略包含名称、描述、适用市场、风险等级
- **页面元素**：策略卡片、策略分类标签、搜索筛选器、策略详情弹窗
- **交互逻辑**：点击策略卡片查看详情 → 确认选择 → 跳转参数配置页
- **跳转逻辑**：选择策略后跳转到参数配置页，携带策略ID

#### 页面2：参数配置页
- **页面目标**：为用户提供灵活的策略参数配置界面
- **核心功能**：策略参数设置、回测时间范围选择、交易成本配置
- **业务逻辑**：根据选择的策略动态生成参数表单，支持参数验证和预设模板
- **页面元素**：参数表单、时间选择器、成本计算器、参数模板选择器
- **交互逻辑**：填写参数 → 参数验证 → 预览配置 → 提交回测任务
- **跳转逻辑**：提交后跳转到回测执行页，携带完整配置信息

#### 页面3：回测执行页
- **页面目标**：实时展示回测执行进度和状态
- **核心功能**：进度展示、状态监控、错误处理、取消操作
- **业务逻辑**：后台执行回测任务，前端定时轮询状态更新，支持任务中断
- **页面元素**：进度条、状态指示器、日志输出区、操作按钮
- **交互逻辑**：自动显示进度 → 完成后自动跳转结果页 → 或手动取消任务
- **跳转逻辑**：回测完成自动跳转到结果展示页

#### 页面4：结果展示页
- **页面目标**：全面展示回测结果和策略分析报告
- **核心功能**：收益曲线图、回撤分析、关键指标展示、报告导出
- **业务逻辑**：展示完整回测报告，包括图表和数值指标，支持多维度分析
- **页面元素**：交互式图表、指标仪表盘、数据表格、导出按钮
- **交互逻辑**：查看详细图表 → 切换不同分析维度 → 导出报告文件
- **跳转逻辑**：可返回参数配置页重新回测，或保存到历史记录

## 4. 用户故事
### P0核心功能：
- 作为策略开发者，我希望选择ETF轮动策略并配置轮动周期，以便验证不同参数下的策略表现
- 业务规则：支持月度/季度/年度轮动周期，可配置轮动的ETF池范围

- 作为策略开发者，我希望设置定投策略的金额和频率，以便测试长期投资效果
- 业务规则：支持定投金额、定投日期、跳过节假日等参数配置

- 作为策略开发者，我希望查看详细的回测报告，以便评估策略的收益和风险特征
- 业务规则：报告包含收益曲线、最大回撤、夏普比率、胜率等关键指标

### P1重要功能：
- 作为程序员朋友，我希望查看策略的代码逻辑，以便理解策略实现原理
- 业务规则：代码查看权限仅限已授权用户，不支持在线编辑

- 作为策略开发者，我希望比较不同参数下的回测结果，以便优化策略参数
- 业务规则：支持多个回测结果的对比展示，最多支持3个结果同时对比

## 5. 用户流程
### 主要操作路径：
1. 用户进入系统 → 2. 选择回测策略 → 3. 配置策略参数 → 4. 执行回测任务 → 5. 查看回测结果

### 页面流转图：
策略选择页 → 参数配置页 → 回测执行页 → 结果展示页 → 策略管理页（可选）

## 6. 产品约束

### 6.1 平台要求
**部署方案对比**：
| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|---------|
| 本地Docker运行 | 数据安全、无网络依赖 | 环境配置复杂、分享困难 | ⭐⭐⭐ |
| **云服务器部署（推荐）** | 易分享、统一维护、跨平台 | 需要服务器成本、数据传输风险 | ⭐⭐⭐⭐⭐ |
| 混合部署 | 兼顾安全和便利 | 架构复杂 | ⭐⭐⭐⭐ |

**最终选择**：云服务器部署 + Docker容器化，支持HTTPS加密传输

### 6.2 技术架构约束
**架构方案**：Monorepo + 前后端分离
```
项目结构：
├── backend/     (Python + FastAPI + Backtrader)
├── frontend/    (React + TypeScript + Ant Design)
├── shared/      (共享类型定义和常量)
└── docs/        (文档)
```

**数据存储方案对比**：
| 方案 | 适用场景 | 优点 | 缺点 | 推荐阶段 |
|------|----------|------|------|----------|
| **SQLite（推荐MVP）** | 个人使用，数据量<1GB | 部署简单、无依赖 | 并发性能有限 | MVP阶段 ⭐⭐⭐⭐⭐ |
| PostgreSQL | 生产环境，多用户 | 性能好、功能完整 | 配置复杂、资源占用高 | 扩展阶段 ⭐⭐⭐⭐ |
| 时序数据库 | 超大规模历史数据 | 专为时间序列优化 | 学习成本高、过度设计 | 大规模阶段 ⭐⭐⭐ |

**最终选择**：MVP使用SQLite，后期可升级至PostgreSQL

### 6.3 数据源约束
**免费数据源方案**：
| 数据源 | 覆盖范围 | 数据质量 | 成本 | 限制条件 |
|---------|----------|----------|------|----------|
| **AKShare（推荐A股）** | A股、ETF、宏观数据 | 高（实时爬取） | 完全免费 | 需要网络连接 |
| **yfinance（推荐美股）** | 美股、全球ETF | 中等（Yahoo数据） | 完全免费 | 部分数据延迟 |
| Tushare | 主要A股数据 | 很高（专业维护） | 500元/年 | 积分限制 |

**数据更新策略**：
- 历史数据：每日凌晨自动更新
- 实时数据：不支持（回测不需要）
- 数据备份：本地缓存30天历史数据

### 6.4 功能边界
**支持功能**：
- ✅ A股和美股ETF回测
- ✅ 多种预设策略（定投、轮动、均值回归等）
- ✅ 灵活参数配置
- ✅ 详细回测报告和可视化
- ✅ 策略代码查看（只读）
- ✅ 历史回测记录管理

**不支持功能**：
- ❌ 实盘交易对接
- ❌ 在线策略编辑器
- ❌ 多用户系统和权限管理
- ❌ 实时行情数据
- ❌ 策略自动优化（遗传算法等）

### 6.5 性能约束
**回测性能要求**：
- 单次回测时间：< 5分钟（3年历史数据）
- 并发支持：单用户系统，不考虑并发
- 数据存储：支持最多10年历史数据
- 内存使用：< 2GB RAM

### 6.6 安全约束
**数据安全**：
- 策略代码知识产权保护：只读访问
- 数据传输：HTTPS加密
- 本地存储：敏感配置文件加密
- 备份策略：每周自动备份回测数据

### 6.7 扩展性考虑
**未来扩展方向**：
1. **策略扩展**：支持更多策略类型（技术指标策略、机器学习策略）
2. **市场扩展**：支持期货、期权、数字货币回测
3. **功能扩展**：策略组合、风险管理模块、实盘模拟
4. **用户扩展**：多用户系统、策略分享社区
5. **开源扩展**：开源核心回测引擎，构建开发者生态

**技术债务管理**：
- 代码规范：使用黑格式化、类型注解、单元测试
- 文档维护：API文档自动生成、用户手册定期更新
- 版本管理：语义化版本控制、向后兼容性保证

### 6.8 风险提示和免责声明
**用户风险提示**：
- ⚠️ 历史业绩不代表未来收益
- ⚠️ 回测结果可能存在过拟合风险
- ⚠️ 实际交易中存在滑点、冲击成本等额外费用
- ⚠️ 数据来源的准确性和及时性无法100%保证
- ⚠️ 策略逻辑仅供学习和研究使用，不构成投资建议

**技术风险**：
- 免费数据源可能存在服务中断风险
- 策略代码可能包含逻辑错误或未考虑的边界情况
- 系统仅适用于学习和研究目的，不建议直接用于实盘交易