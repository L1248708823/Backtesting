name: é‡åŒ–å›æµ‹ç³»ç»Ÿè‡ªåŠ¨éƒ¨ç½²

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: ${{ secrets.PORT || '22' }}
        script: |
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd ${{ secrets.PROJECT_PATH || '/opt/quant-backtest/Backtesting' }}
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main
          
          # åœæ­¢ç°æœ‰å®¹å™¨
          echo "ğŸ›‘ åœæ­¢ç°æœ‰å®¹å™¨..."
          docker-compose down
          
          # æ¸…ç†æ—§é•œåƒï¼ˆå¯é€‰ï¼ŒèŠ‚çœç©ºé—´ï¼‰
          echo "ğŸ§¹ æ¸…ç†Dockerç¼“å­˜..."
          docker system prune -f
          
          # é‡æ–°æ„å»ºå¹¶å¯åŠ¨å®¹å™¨
          echo "ğŸ—ï¸ é‡æ–°æ„å»ºå’Œå¯åŠ¨å®¹å™¨..."
          docker-compose up -d --build
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
          else
            echo "âŒ åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥ï¼"
            docker-compose logs backend
            exit 1
          fi
          
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… å‰ç«¯æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
          else
            echo "âŒ å‰ç«¯æœåŠ¡å¯åŠ¨å¤±è´¥ï¼"
            docker-compose logs frontend
            exit 1
          fi
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          docker-compose ps