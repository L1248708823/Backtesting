name: 量化回测系统自动部署

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发部署

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: 部署到服务器
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: ${{ secrets.PORT || '22' }}
        script: |
          # 进入项目目录
          cd ${{ secrets.PROJECT_PATH || '/opt/quant-backtest/Backtesting' }}
          
          # 拉取最新代码
          echo "📥 拉取最新代码..."
          git pull origin main
          
          # 停止现有容器
          echo "🛑 停止现有容器..."
          docker-compose down
          
          # 清理旧镜像（可选，节省空间）
          echo "🧹 清理Docker缓存..."
          docker system prune -f
          
          # 重新构建并启动容器
          echo "🏗️ 重新构建和启动容器..."
          docker-compose up -d --build
          
          # 等待服务启动
          echo "⏳ 等待服务启动..."
          sleep 30
          
          # 健康检查
          echo "🔍 检查服务健康状态..."
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "✅ 后端服务启动成功！"
          else
            echo "❌ 后端服务启动失败！"
            docker-compose logs backend
            exit 1
          fi
          
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "✅ 前端服务启动成功！"
          else
            echo "❌ 前端服务启动失败！"
            docker-compose logs frontend
            exit 1
          fi
          
          echo "🎉 部署完成！"
          docker-compose ps